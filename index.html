<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Documentos de Engenharia da GSTE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <script src="https://code.highcharts.com/modules/cylinder.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <style>
        :root {
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --bg-card: #ffffff;
            --text-primary: #333;
            --border-color: #ddd;
            
            /* Cores de Status */
            --color-green-light: #d4edda;
            --text-green-light: #155724;
            --color-blue: #cce5ff;
            --text-blue: #004085;
            --color-yellow: #fff3cd;
            --text-yellow: #856404;
            --color-green-dark: #198754;
            --text-green-dark: #ffffff;
            --color-orange-dark: #fd7e14;
            --text-orange-dark: #ffffff;
            --color-red: #f8d7da;
            --text-red: #721c24;
            --color-purple: #e2d1f0;
            --text-purple: #4b0082;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #008e9a, #6f6e6e);
            min-height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 10px;
        }

        h1 {
            margin-top: 0;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }

        .container {
            width: 98%;
            max-width: none;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: start;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            position: relative; 
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .multiselect-dropdown { position: relative; user-select: none; }
        .multiselect-btn {
            width: 100%;
            padding: 8px 12px; background-color: white;
            border: 1px solid var(--border-color); border-radius: 4px;
            cursor: pointer; text-align: left; display: flex;
            justify-content: space-between;
            align-items: center; font-size: 0.9rem;
        }
        .multiselect-btn::after { content: '▼'; font-size: 0.7em; margin-left: 10px; opacity: 0.6; }
        .multiselect-content {
            display: none;
            position: absolute; top: 100%; left: 0; width: 100%;
            min-width: 250px; max-height: 300px; overflow-y: auto;
            background-color: white; border: 1px solid var(--border-color);
            border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000; padding: 5px 0;
        }
        .multiselect-content.show { display: block; }
        .multiselect-option { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; }
        .multiselect-option:hover { background-color: #f1f1f1; }
        .multiselect-option input { margin-right: 10px; cursor: pointer; }
        
        .clear-btn {
            margin-top: 23px;
            padding: 9px 15px; cursor: pointer;
            background: #6c757d; color: white; border: none;
            border-radius: 4px; font-size: 0.9rem;
        }
        .delete-btn {
            margin-top: 23px;
            padding: 9px 15px; cursor: pointer;
            background: #dc3545; color: white; border: none;
            border-radius: 4px; font-size: 0.9rem;
        }

        .upload-controls {
            display: flex;
            gap: 20px; margin-bottom: 10px;
            justify-content: center; align-items: center;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px; text-align: center;
            cursor: pointer; transition: border 0.3s; margin-top: 10px;
        }
        .upload-area:hover { border-color: #66afe9; background-color: #f9fbfd; }

        .charts-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            flex: 1;
            min-width: 400px;
            height: 400px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }

        .table-responsive { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse; font-size: 0.85rem; table-layout: fixed;
        }
        
        table th:nth-child(1) { width: 15%; }
        table th:nth-child(2) { width: 25%; }
        table th:nth-child(3) { width: 8%; } 
        table th:nth-child(4) { width: 12%; }
        table th:nth-child(5) { width: 12%; }
        table th:nth-child(6) { width: 18%; }
        table th:nth-child(7) { width: 10%; }

        thead { position: sticky; top: 0; background-color: #343a40; color: white; z-index: 10; }
        th, td { 
            padding: 10px 12px; 
            text-align: left; 
            border-bottom: 1px solid var(--border-color); 
            word-wrap: break-word; 
            position: relative;
        }
        th { cursor: pointer; user-select: none; transition: background 0.2s; }
        th:hover { background-color: #495057; }
        .sort-icon { font-size: 0.8rem; margin-left: 5px; opacity: 0.7; }

        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            height: 100%;
            z-index: 1;
        }
        .resizer:hover, .resizing { background-color: #66afe9; }

        /* Cores das Linhas por Status */
        tr.status-verde-claro { background-color: var(--color-green-light); color: var(--text-green-light); }
        tr.status-azul { background-color: var(--color-blue); color: var(--text-blue); }
        tr.status-amarelo { background-color: var(--color-yellow); color: var(--text-yellow); }
        tr.status-verde-escuro { background-color: var(--color-green-dark); color: var(--text-green-dark); }
        tr.status-laranja-escuro { background-color: var(--color-orange-dark); color: var(--text-orange-dark); }
        tr.status-vermelho { background-color: var(--color-red); color: var(--text-red); }
        tr.status-roxo { background-color: var(--color-purple); color: var(--text-purple); }
        
        .stats-summary { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>Controle de Documentos de Engenharia da GSTE</h1>
        
        <div class="upload-controls">
            <div>
                <label for="encodingSelect" style="font-weight: bold; margin-right: 5px;">Codificação:</label>
                <select id="encodingSelect" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="AUTO">Automático (Recomendado)</option>
                    <option value="UTF-8">UTF-8 (Padrão Novo)</option>
                    <option value="ISO-8859-1">Latin1 (Padrão Antigo)</option>
                </select>
            </div>
        </div>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <h3>Clique para fazer Upload dos Arquivos (CSV)</h3>
            <p>Ordenação disponível clicando nos títulos das colunas</p>
            <input type="file" id="fileInput" accept=".csv,.json" multiple onchange="handleFileUpload(event)">
        </div>
    </div>

    <div class="card" id="dashboardPanel" style="display:none;">
        <div class="filters-container">
            <div id="filterProjectContainer" class="filter-group"></div>
            <div id="filterStatusContainer" class="filter-group"></div>
            <div id="filterSubstationContainer" class="filter-group"></div>
            <div id="filterPhaseContainer" class="filter-group"></div>
            <div id="filterScopeContainer" class="filter-group"></div>
            <div id="filterTechGroupContainer" class="filter-group"></div>
            <div id="filterVendorContainer" class="filter-group"></div>
            
            <div class="filter-group" style="flex-direction: row; gap: 10px;">
                <button class="clear-btn" onclick="resetFilters()">Limpar Filtros</button>
                <button class="delete-btn" onclick="deleteObsoleteItems()">Excluir Obsoletos/Cancelados</button>
            </div>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div class="charts-row">
            <div id="pieChartContainer" class="chart-container"></div>
            <div id="barChartContainer" class="chart-container"></div>
        </div>
    </div>

    <div class="card" id="tablePanel" style="display:none;">
        <div class="stats-summary">
            <span id="totalCount">Total: 0</span>
            <span id="filteredCount">Exibindo: 0</span>
        </div>
        <div class="table-responsive">
            <table id="docTable">
                <thead>
                    <tr>
                        <th data-column="titulo" onclick="sortTable('titulo')">Título <span class="sort-icon">⇅</span></th>
                        <th data-column="descricao" onclick="sortTable('descricao')">Descrição <span class="sort-icon">⇅</span></th>
                        <th data-column="escopo" onclick="sortTable('escopo')">Escopo <span class="sort-icon">⇅</span></th>
                        <th data-column="fornecedor" onclick="sortTable('fornecedor')">Fornecedor <span class="sort-icon">⇅</span></th>
                        <th data-column="subestacaoName" onclick="sortTable('subestacaoName')">Subestação <span class="sort-icon">⇅</span></th>
                        <th data-column="statusRaw" onclick="sortTable('statusRaw')">Status <span class="sort-icon">⇅</span></th>
                        <th data-column="dataAtualizacao" onclick="sortTable('dataAtualizacao')">Última Atualização <span class="sort-icon">⇅</span></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let filteredData = [];
    let sortState = { column: null, asc: true };

    let activeFilters = {
        project: [], status: [], substation: [], phase: [], scope: [], vendor: [], technicalGroup: [] 
    };

    const substationMap = {
        'CID02': 'SE Ceará Mirim', 'JPSE': 'SE João Pessoa', 'SE5P1': 'SE Pau Ferro', 'SE5G1': 'SE Garanhuns',
        'MSI08': 'SE Messias', 'PLS': 'SE Pilões', 'CAP3': 'SE Capelinha 3', 'IBC': 'SE Ibicoara', 
        'IGAP': 'SE Igaporã', 'ITB5': 'SE Itabira 5', 'JUSS': 'SE Jussiape', 'SJP': 'SE São João do Paraíso',
        'OUR': 'SE Ourolândia'
    };
    
    const statusConfig = {
        'VERDE_CLARO': { label: 'Aprovado / Comentários', class: 'status-verde-claro', hex: '#28a745' },
        'AZUL': { label: 'Em Análise', class: 'status-azul', hex: '#007bff' },
        'AMARELO': { label: 'Previsto', class: 'status-amarelo', hex: '#ffc107' },
        'VERDE_ESCURO': { label: 'Liberado Execução', class: 'status-verde-escuro', hex: '#155724' },
        'LARANJA': { label: 'Não Aprovado / Recusado', class: 'status-laranja-escuro', hex: '#fd7e14' },
        'ATRASADO': { label: 'Atrasado', class: 'status-vermelho', hex: '#dc3545' },
        'OBSOLETO': { label: 'Obsoleto / Cancelado', class: 'status-roxo', hex: '#6f42c1' },
        'OUTROS': { label: 'Indefinido', class: '', hex: '#6c757d' }
    };

    function handleFileUpload(event) {
        const files = event.target.files;
        if (!files.length) return;
        rawData = []; 
        let filesProcessed = 0;
        const userEncoding = document.getElementById('encodingSelect').value;
        Array.from(files).forEach(file => {
            parseFile(file, userEncoding, (data, fields) => {
                processCSVData(data, fields);
                filesProcessed++;
                if (filesProcessed === files.length) initDashboard();
            });
        });
    }

    function parseFile(file, encodingMode, callback) {
        let currentEncoding = (encodingMode === 'AUTO') ? 'UTF-8' : encodingMode;
        Papa.parse(file, {
            header: true, delimiter: "", encoding: currentEncoding, skipEmptyLines: true,
            complete: function(results) {
                if (encodingMode === 'AUTO') {
                    const headers = results.meta.fields || [];
                    const firstRow = results.data[0] || {};
                    const hasErrorChar = headers.some(h => h.includes('')) || Object.values(firstRow).some(v => typeof v === 'string' && v.includes(''));
                    if (hasErrorChar) {
                        Papa.parse(file, {
                            header: true, delimiter: "", encoding: "ISO-8859-1", skipEmptyLines: true,
                            complete: function(retryResults) { callback(retryResults.data, retryResults.meta.fields); }
                        });
                        return;
                    }
                }
                callback(results.data, results.meta.fields);
            }
        });
    }

    function processCSVData(data, fields) {
        const mapped = data.map(row => {
            const keys = Object.keys(row);
            const getExact = (target) => {
                const key = keys.find(k => k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === target);
                return key ? row[key] : '';
            }
            const titulo = getExact('titulo') || '';
            const descricao = getExact('descricao') || '';
            const statusRaw = getExact('estado atual') || getExact('status') || '';
            
            let latestDateStr = '';
            let latestDateObj = null;
            if (fields && fields.length > 10) {
                for (let i = 10; i <= Math.min(fields.length - 1, 35); i++) {
                    const val = row[fields[i]];
                    const parsed = tryParseDate(val);
                    if (parsed && (!latestDateObj || parsed > latestDateObj)) {
                        latestDateObj = parsed;
                        latestDateStr = val;
                    }
                }
            }

            const subInfo = detectSubstation(titulo + ' ' + descricao);
            return {
                titulo, descricao, 
                escopo: getExact('pasta') || getExact('escopo') || extractScopeFromPath(getExact('caminho')) || 'GERAL', 
                fornecedor: getExact('autor') || getExact('fornecedor') || '', 
                statusRaw, statusCategory: categorizeStatus(statusRaw), 
                dataAtualizacao: latestDateStr, 
                subestacaoName: subInfo.name, fase: detectPhase(titulo), projeto: detectProject(titulo), 
                grupoTecnico: detectTechnicalGroup(descricao)
            };
        });
        rawData = rawData.concat(mapped);
    }

    function tryParseDate(dateStr) {
        if (!dateStr) return null;
        dateStr = dateStr.trim();
        const partsBR = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
        if (partsBR) return new Date(partsBR[3], partsBR[2] - 1, partsBR[1]);
        const partsISO = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (partsISO) return new Date(partsISO[1], partsISO[2] - 1, partsISO[3]);
        return null;
    }

    function extractScopeFromPath(path) {
        if (!path) return '';
        const parts = path.split(/[/\\]/);
        const idx = parts.findIndex(p => p.toLowerCase() === 'doc_tecnicos');
        return (idx !== -1 && idx + 1 < parts.length) ? parts[idx + 1] : '';
    }

    function detectProject(text) {
        const upperText = text.toUpperCase();
        for (const proj of ['GST001', 'GST002', 'GST003', 'GST004']) if (upperText.includes(proj)) return proj;
        return 'Outros';
    }

    function detectSubstation(text) {
        const upperText = text.toUpperCase();
        for (const [code, name] of Object.entries(substationMap)) if (upperText.includes(code)) return { code, name: `${code} - ${name}` };
        return { code: 'OUTROS', name: 'Outros / Geral' };
    }

    function detectPhase(text) {
        const upperText = text.toUpperCase();
        if (upperText.includes('BAS')) return 'Básico (BAS)';
        if (upperText.includes('EXE')) return 'Executivo (EXE)';
        return 'N/A';
    }

    function detectTechnicalGroup(desc) {
        if (!desc) return 'Geral / Outros';
        const d = desc.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if (d.includes('casa de comando') || d.includes('edificacao') || d.includes('casa de controle')) return 'Casa de Comanda e Edificações';
        if (d.includes('terraplenagem')) return 'Terraplenagem';
        if (d.includes('drenagem')) return 'Drenagem';
        if (d.includes('malha') && (d.includes('terra') || d.includes('aterramento'))) return 'Malha de Terra';
        if (d.includes('fundacao') && d.includes('portico')) return 'Fundações de Pórticos';
        const equipTerms = ['equipamento', 'tc', 'tp', 'disjuntor', 'seccionador', 'bobina', 'reator', ' ip', 'bloqueio'];
        if (d.includes('fundacao') && equipTerms.some(term => d.includes(term))) return 'Fundação de Equipamento (TC, TP, Disjuntores e Chaves Seccionadores, IP, Bobinas de Bloqueio, Reatores a seco, Reatores a oleo)';
        if (d.includes('requisito') && d.includes('suporte')) return 'Requisitos de Suportes de Equipamentos';
        if (d.includes('requisito') && d.includes('portico')) return 'Requisitos de Pórticos';
        if (d.includes('detalhe') && d.includes('instalacao')) return 'Detalhes de instalação de Equipamentos';
        return 'Geral / Outros';
    }

    function categorizeStatus(status) {
        if(!status) return 'OUTROS';
        const s = status.toLowerCase().trim();
        if (s.includes('obsoleto') || s.includes('cancelado')) return 'OBSOLETO';
        if (s.includes('atrasado')) return 'ATRASADO';
        if (s.includes('aprovado') && !s.includes('não aprovado')) return 'VERDE_CLARO';
        if (s.includes('liberado para execução')) return 'VERDE_ESCURO';
        if (s.includes('análise') || s.includes('analise')) return 'AZUL';
        if (s.includes('previsto')) return 'AMARELO';
        if (s.includes('não aprovado') || s.includes('recusado')) return 'LARANJA';
        return 'OUTROS';
    }

    // --- Lógica de Ordenação Atualizada ---
    function sortTable(column) {
        if (sortState.column === column) {
            sortState.asc = !sortState.asc;
        } else {
            sortState.column = column;
            sortState.asc = true;
        }

        // Atualizar ícones visualmente
        document.querySelectorAll('th .sort-icon').forEach(icon => icon.innerText = '⇅');
        const activeHeader = document.querySelector(`th[data-column="${column}"] .sort-icon`);
        if (activeHeader) activeHeader.innerText = sortState.asc ? '▲' : '▼';

        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        if (sortState.column) {
            filteredData.sort((a, b) => {
                let valA = a[sortState.column] || '';
                let valB = b[sortState.column] || '';

                // Tratamento especial para datas DD/MM/YYYY
                if (sortState.column === 'dataAtualizacao') {
                    const dateA = tryParseDate(valA) || new Date(0);
                    const dateB = tryParseDate(valB) || new Date(0);
                    return sortState.asc ? dateA - dateB : dateB - dateA;
                }

                // Ordenação de texto padrão
                const comparison = String(valA).localeCompare(String(valB), 'pt-BR', { sensitivity: 'base' });
                return sortState.asc ? comparison : -comparison;
            });
        }

        filteredData.forEach(item => {
            const tr = document.createElement('tr');
            const config = statusConfig[item.statusCategory] || statusConfig['OUTROS'];
            tr.className = config.class;
            tr.innerHTML = `<td>${item.titulo}</td><td>${item.descricao}</td><td>${item.escopo}</td><td>${item.fornecedor}</td><td>${item.subestacaoName}</td><td>${item.statusRaw}</td><td>${item.dataAtualizacao}</td>`;
            tbody.appendChild(tr);
        });
    }

    // --- Outras Funções do Dashboard ---
    function initDashboard() {
        document.getElementById('dashboardPanel').style.display = 'block';
        document.getElementById('tablePanel').style.display = 'block';
        populateFilters();
        applyFilters();
        initColumnResize();
    }

    function createMultiSelect(containerId, labelText, options, filterKey) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; 
        const label = document.createElement('label'); label.innerText = labelText; container.appendChild(label);
        const dd = document.createElement('div'); dd.className = 'multiselect-dropdown';
        const btn = document.createElement('div'); btn.className = 'multiselect-btn'; btn.innerText = 'Todos';
        btn.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll('.multiselect-content').forEach(el => { if(el !== content) el.classList.remove('show'); });
            content.classList.toggle('show');
        };
        dd.appendChild(btn);
        const content = document.createElement('div'); content.className = 'multiselect-content';
        options.forEach(optVal => {
            const optDiv = document.createElement('div'); optDiv.className = 'multiselect-option';
            const checkbox = document.createElement('input'); checkbox.type = 'checkbox';
            checkbox.value = optVal.value; checkbox.checked = activeFilters[filterKey].includes(optVal.value);
            checkbox.onchange = () => {
                if (checkbox.checked) { if (!activeFilters[filterKey].includes(optVal.value)) activeFilters[filterKey].push(optVal.value); }
                else activeFilters[filterKey] = activeFilters[filterKey].filter(v => v !== optVal.value);
                updateButtonText(btn, filterKey); applyFilters();
            };
            const txt = document.createElement('span'); txt.innerText = optVal.label;
            optDiv.onclick = (e) => { if(e.target !== checkbox) { checkbox.checked = !checkbox.checked; checkbox.onchange(); } };
            optDiv.appendChild(checkbox); optDiv.appendChild(txt); content.appendChild(optDiv);
        });
        dd.appendChild(content); container.appendChild(dd);
    }
    
    function updateButtonText(btnElement, key) {
        const count = activeFilters[key].length;
        btnElement.innerText = count === 0 ? 'Todos' : (count === 1 ? '1 Selecionado' : `${count} Selecionados`);
    }

    window.onclick = function(event) {
        if (!event.target.matches('.multiselect-btn') && !event.target.closest('.multiselect-content')) {
            document.querySelectorAll('.multiselect-content').forEach(el => el.classList.remove('show'));
        }
    }

    function populateFilters() {
        const getOptions = (key) => [...new Set(rawData.map(item => item[key]).filter(x => x))].sort().map(v => ({ value: v, label: v }));
        const statusOpts = Object.keys(statusConfig).filter(k => k !== 'OUTROS').map(k => ({ value: k, label: statusConfig[k].label }));
        createMultiSelect('filterProjectContainer', 'Projeto', getOptions('projeto'), 'project');
        createMultiSelect('filterStatusContainer', 'Status', statusOpts, 'status');
        createMultiSelect('filterSubstationContainer', 'Subestação', getOptions('subestacaoName'), 'substation');
        createMultiSelect('filterPhaseContainer', 'Fase', getOptions('fase'), 'phase');
        createMultiSelect('filterScopeContainer', 'Escopo (Pasta)', getOptions('escopo'), 'scope');
        createMultiSelect('filterTechGroupContainer', 'Disciplina / Grupo Técnico', getOptions('grupoTecnico'), 'technicalGroup');
        createMultiSelect('filterVendorContainer', 'Fornecedor', getOptions('fornecedor'), 'vendor');
    }

    function applyFilters() {
        filteredData = rawData.filter(item => {
            return (activeFilters.project.length === 0 || activeFilters.project.includes(item.projeto)) &&
                   (activeFilters.status.length === 0 || activeFilters.status.includes(item.statusCategory)) &&
                   (activeFilters.substation.length === 0 || activeFilters.substation.includes(item.subestacaoName)) &&
                   (activeFilters.phase.length === 0 || activeFilters.phase.includes(item.fase)) &&
                   (activeFilters.scope.length === 0 || activeFilters.scope.includes(item.escopo)) &&
                   (activeFilters.vendor.length === 0 || activeFilters.vendor.includes(item.fornecedor)) &&
                   (activeFilters.technicalGroup.length === 0 || activeFilters.technicalGroup.includes(item.grupoTecnico));
        });
        document.getElementById('totalCount').innerText = `Total: ${rawData.length}`;
        document.getElementById('filteredCount').innerText = `Exibindo: ${filteredData.length}`;
        renderTable();
        renderCharts();
    }

    function resetFilters() {
        Object.keys(activeFilters).forEach(k => activeFilters[k] = []);
        populateFilters();
        applyFilters();
    }

    function deleteObsoleteItems() {
        const countBefore = rawData.length;
        rawData = rawData.filter(item => item.statusCategory !== 'OBSOLETO');
        if (countBefore - rawData.length > 0) {
            alert(`${countBefore - rawData.length} itens removidos.`);
            applyFilters();
        } else alert("Nenhum item obsoleto encontrado.");
    }

    function initColumnResize() {
        document.querySelectorAll('th').forEach(col => {
            const resizer = document.createElement('div');
            resizer.classList.add('resizer');
            col.appendChild(resizer);
            resizer.addEventListener('mousedown', (e) => {
                const startX = e.clientX;
                const startW = col.offsetWidth;
                const onMouseMove = (e) => { col.style.width = (startW + e.clientX - startX) + 'px'; };
                const onMouseUp = () => { document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function renderCharts() {
        const counts = {};
        Object.keys(statusConfig).forEach(key => counts[key] = 0);
        filteredData.forEach(item => { counts[item.statusCategory]++; });
        const pieData = Object.keys(statusConfig).filter(k => counts[k] > 0).map(k => ({ name: statusConfig[k].label, y: counts[k], color: statusConfig[k].hex }));
        
        Highcharts.chart('pieChartContainer', {
            chart: { type: 'pie', options3d: { enabled: true, alpha: 45, beta: 0 } },
            title: { text: 'Distribuição por Status' },
            plotOptions: { pie: { depth: 35, dataLabels: { enabled: true, format: '{point.name}: {point.y}' } } },
            series: [{ name: 'Documentos', data: pieData }]
        });
        
        const scopes = [...new Set(filteredData.map(d => d.escopo))].sort();
        const seriesLib = scopes.map(s => filteredData.filter(d => d.escopo === s && d.statusCategory === 'VERDE_ESCURO').length);
        const seriesRest = scopes.map((s, i) => filteredData.filter(d => d.escopo === s).length - seriesLib[i]);
        
        Highcharts.chart('barChartContainer', {
            chart: { type: 'column' },
            title: { text: '% Avanço (Liberado para Execução)' },
            xAxis: { categories: scopes, labels: { rotation: -45 } },
            yAxis: { min: 0, title: { text: 'Quantidade' } },
            plotOptions: { column: { stacking: 'percent' } },
            series: [
                { name: 'Restante', data: seriesRest, color: '#ffc107' },
                { name: 'Liberado', data: seriesLib, color: '#198754' }
            ]
        });
    }
</script>

</body>
</html>
